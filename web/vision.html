<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Recognition - GopherAI Resume</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f3f4f6; color: #111827; }
    .topbar { background: #fff; border-bottom: 1px solid #e5e7eb; padding: 10px 14px; display: flex; justify-content: space-between; align-items: center; }
    .back { border: 0; border-radius: 8px; padding: 8px 12px; background: #4b5563; color: #fff; cursor: pointer; text-decoration: none; font-size: 14px; }
    .back:hover { background: #374151; }
    .main { max-width: 720px; margin: 24px auto; padding: 0 14px; }
    .panel { background: #fff; border-radius: 12px; box-shadow: 0 4px 14px rgba(0,0,0,.06); padding: 24px; margin-bottom: 16px; }
    .panel h3 { margin: 0 0 12px; font-size: 18px; }
    input[type="file"] { margin: 8px 0; font-size: 14px; }
    .btn { border: 0; border-radius: 8px; padding: 10px 16px; color: #fff; background: #2563eb; cursor: pointer; font-size: 14px; margin-top: 8px; }
    .btn:hover { background: #1d4ed8; }
    .btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .msg { margin-top: 12px; font-size: 14px; color: #6b7280; }
    .err { color: #dc2626; }
    .preview { max-width: 100%; max-height: 280px; border-radius: 8px; border: 1px solid #e5e7eb; margin-top: 12px; display: block; }
    .predictions { margin-top: 16px; border-top: 1px solid #e5e7eb; padding-top: 16px; }
    .pred-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #f9fafb; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e5e7eb; }
    .pred-item .label { font-weight: 500; }
    .pred-item .score { font-size: 13px; color: #6b7280; }
  </style>
</head>
<body>
  <div class="topbar">
    <h2 style="margin:0;font-size:18px;">Image Recognition</h2>
    <a href="/app" class="back">Back to App</a>
  </div>
  <div class="main">
    <div class="panel">
      <h3>Classify image (MobileNetV2)</h3>
      <p style="margin:0 0 12px;font-size:14px;color:#6b7280;">Upload an image to classify with the local ONNX model. Top ImageNet predictions will appear below.</p>
      <input type="file" id="imageFile" accept="image/jpeg,image/png,image/gif,image/webp">
      <img id="preview" class="preview" src="" alt="" style="display: none;">
      <button class="btn" id="classifyBtn" type="button">Classify</button>
      <div id="msg" class="msg"></div>
      <div id="predictions" class="predictions" style="display: none;">
        <strong>Top predictions</strong>
        <div id="predictionsList"></div>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem("token");
    if (!token) {
      window.location.href = "/login";
    }

    const imageFile = document.getElementById("imageFile");
    const preview = document.getElementById("preview");
    const classifyBtn = document.getElementById("classifyBtn");
    const msg = document.getElementById("msg");
    const predictionsBox = document.getElementById("predictions");
    const predictionsList = document.getElementById("predictionsList");

    imageFile.addEventListener("change", function () {
      msg.textContent = "";
      msg.classList.remove("err");
      predictionsBox.style.display = "none";
      if (this.files && this.files[0]) {
        const url = URL.createObjectURL(this.files[0]);
        preview.src = url;
        preview.style.display = "block";
      } else {
        preview.src = "";
        preview.style.display = "none";
      }
    });

    classifyBtn.addEventListener("click", async function () {
      if (!imageFile.files || imageFile.files.length === 0) {
        msg.textContent = "Please select an image.";
        msg.classList.add("err");
        return;
      }
      const file = imageFile.files[0];
      if (file.size > 5 * 1024 * 1024) {
        msg.textContent = "Image too large (max 5MB).";
        msg.classList.add("err");
        return;
      }

      msg.textContent = "Classifying...";
      msg.classList.remove("err");
      predictionsBox.style.display = "none";
      classifyBtn.disabled = true;

      const form = new FormData();
      form.append("image", file);

      try {
        const res = await fetch("/api/v1/vision/classify", {
          method: "POST",
          headers: { "Authorization": "Bearer " + (localStorage.getItem("token") || "") },
          body: form
        });
        const data = await res.json();

        if (res.ok && data.code === 0) {
          msg.textContent = "";
          const preds = data.data.predictions || [];
          predictionsList.innerHTML = preds.map(function (p) {
            return '<div class="pred-item"><span class="label">' + escapeHtml(p.label || "?") + '</span><span class="score">' + (typeof p.score === "number" ? p.score.toFixed(4) : p.score) + '</span></div>';
          }).join("");
          predictionsBox.style.display = "block";
        } else {
          msg.textContent = data.message || "Classification failed.";
          msg.classList.add("err");
        }
      } catch (e) {
        msg.textContent = "Request error: " + e.message;
        msg.classList.add("err");
      } finally {
        classifyBtn.disabled = false;
      }
    });

    function escapeHtml(s) {
      const div = document.createElement("div");
      div.textContent = s;
      return div.innerHTML;
    }
  </script>
</body>
</html>
